# Markdown Collaborative Editor v6.7 - å¤‰æ›´å†…å®¹

## ğŸ“¦ ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

1. **server.js** (791è¡Œã€28KB)
2. **index.html** (1776è¡Œã€61KB)

---

## ğŸ¯ å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½

### 1. AIæŒ‡ç¤ºã®æ–‡å­—æ•°åˆ¶é™æ’¤å»ƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `security.js` (å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã€ä¿®æ­£ã¯åˆ¥é€”å¿…è¦)
- 500æ–‡å­—åˆ¶é™ã‚’å‰Šé™¤
- ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã§ã®é•·æ–‡AIæŒ‡ç¤ºãŒå¯èƒ½ã«

### 2. AIãƒ¢ãƒ‡ãƒ«ã®è‡ªç”±é¸æŠæ©Ÿèƒ½

#### server.js ã®å¤‰æ›´

**A. ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ãƒ¢ãƒ‡ãƒ«æƒ…å ±è¿½åŠ  (171è¡Œç›®)**
```javascript
rooms.set(roomId, {
    template: dbRoom.template,
    clients: new Map(),
    createdAt: new Date(dbRoom.created_at),
    templateFile: templateFile,
    model: 'gemma3:latest'  // â˜…è¿½åŠ ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«
});
```

**B. ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©è¿½åŠ  (606-656è¡Œç›®)**
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- Ollamaã¸ã®å­˜åœ¨ç¢ºèª
- å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é€šçŸ¥
- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 

**C. callOllamaé–¢æ•°ã®ä¿®æ­£ (697è¡Œç›®)**
```javascript
async function callOllama(currentTemplate, instruction, temperature = 0.3, model = 'gemma3:latest')
```
- ç¬¬4å¼•æ•°ã«ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
- å‹•çš„ãªãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ãŒå¯èƒ½ã«

**D. åˆæœŸãƒ‡ãƒ¼ã‚¿ã«ãƒ¢ãƒ‡ãƒ«æƒ…å ±è¿½åŠ  (395-401è¡Œç›®)**
```javascript
ws.send(JSON.stringify({
    type: 'init',
    userId: userId,
    userName: userData.name,
    template: room.template,
    messages: messages,
    users: getUserList(roomId),
    model: room.model  // â˜…è¿½åŠ 
}));
```

#### index.html ã®å¤‰æ›´

**A. disabledå±æ€§ã®å‰Šé™¤ (878è¡Œç›®)**
```html
<select id="model-select" title="AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ">
```
- UIä¸Šã§ãƒ¢ãƒ‡ãƒ«é¸æŠãŒå¯èƒ½ã«

**B. ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ  (1491-1512è¡Œç›®)**
```javascript
document.getElementById('model-select').addEventListener('change', (e) => {
    const modelName = e.target.value;
    if (!modelName) return;
    
    try {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'change_model',
                model: modelName
            }));
            console.log('ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', modelName);
        } else {
            showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
    } catch (error) {
        console.error('ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
        showError('ãƒ¢ãƒ‡ãƒ«ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
});
```

**C. åˆæœŸåŒ–æ™‚ã®ãƒ¢ãƒ‡ãƒ«åæ˜  (1592-1595è¡Œç›®)**
```javascript
// â˜…ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã®åæ˜ ï¼ˆè¿½åŠ ï¼‰
if (data.model) {
    document.getElementById('model-select').value = data.model;
}
```

**D. model_changedãƒãƒ³ãƒ‰ãƒ©è¿½åŠ  (1641-1646è¡Œç›®)**
```javascript
case 'model_changed':
    const modelSelect = document.getElementById('model-select');
    modelSelect.value = data.model;
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ 'new_message' ã§åˆ¥é€”å—ä¿¡ã•ã‚Œã‚‹
    break;
```

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### ãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§ãƒ¢ãƒ‡ãƒ«é¸æŠ
    â†“
[Client] changeã‚¤ãƒ™ãƒ³ãƒˆ â†’ WebSocketã§é€ä¿¡
    type: 'change_model'
    model: 'phi4-mini:latest'
    â†“
[Server] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    1. ãƒ¢ãƒ‡ãƒ«åã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    2. Ollamaã§ã®å­˜åœ¨ç¢ºèª
    â†“
[Server] room.model ã‚’æ›´æ–°
    â†“
[Server] broadcastToRoom()
    type: 'model_changed'
    model: 'phi4-mini:latest'
    â†“
[Server] ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    "ğŸ¤– ç”°ä¸­ãŒAIãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´: phi4-mini:latest"
    â†“
[All Clients] ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–° + ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

### AIç·¨é›†æ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] @AI æŒ‡ç¤ºå†…å®¹ (Temperature: 0.3)
    â†“
[Client] settings.temperature ã‚’ä»˜ä¸ã—ã¦é€ä¿¡
    â†“
[Server] callOllama(template, instruction, 0.3, room.model)
                                                   ^^^^^^^^
                                            ãƒ«ãƒ¼ãƒ ã”ã¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
    â†“
[Ollama] é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã§å‡¦ç†
    â†“
[Server] çµæœã‚’ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
```

---

## âœ… ãƒ†ã‚¹ãƒˆé …ç›®

### åŸºæœ¬å‹•ä½œ
- [x] ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [x] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`gemma3:latest`ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹
- [x] å¤‰æ›´ãŒã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€šçŸ¥ã•ã‚Œã‚‹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
- [x] ä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚‚åæ˜ ã•ã‚Œã‚‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [x] ç„¡åŠ¹ãªãƒ¢ãƒ‡ãƒ«åã¯æ‹’å¦ã•ã‚Œã‚‹
- [x] å­˜åœ¨ã—ãªã„ãƒ¢ãƒ‡ãƒ«ã¯æ‹’å¦ã•ã‚Œã‚‹
- [x] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹

### AIå‹•ä½œ
- [x] ãƒ¢ãƒ‡ãƒ«å¤‰æ›´å¾Œã®AIç·¨é›†ã§æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ãŒä½¿ã‚ã‚Œã‚‹
- [x] Temperatureè¨­å®šãŒå¼•ãç¶šãæ©Ÿèƒ½ã™ã‚‹
- [x] ãƒ«ãƒ¼ãƒ ã”ã¨ã«ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨å¯èƒ½

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
- [x] æ¥ç¶šä¸­ã«ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹
- [x] è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«å¤‰æ›´ã—ã¦ã‚‚å•é¡Œãªã„
- [x] ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•å¾Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆgemma3:latestï¼‰ã«æˆ»ã‚‹

---

## ğŸ“Š çµ±è¨ˆ

| é …ç›® | å€¤ |
|-----|-----|
| ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•° | 2 |
| è¿½åŠ è¡Œæ•° | ç´„85è¡Œ |
| ä¿®æ­£è¡Œæ•° | 4è¡Œ |
| æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© | 2å€‹ |
| æ–°è¦WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— | 2å€‹ (change_model, model_changed) |

---

## ğŸ‰ ãƒãƒ¼ã‚¸ãƒ§ãƒ³

**v6.6 â†’ v6.7**

### ä¸»ãªå¤‰æ›´
1. AIæŒ‡ç¤ºã®æ–‡å­—æ•°åˆ¶é™æ’¤å»ƒï¼ˆãƒãƒ«ãƒãƒã‚¤ãƒˆå¯¾å¿œï¼‰
2. AIãƒ¢ãƒ‡ãƒ«ã®è‡ªç”±é¸æŠæ©Ÿèƒ½ï¼ˆãƒ«ãƒ¼ãƒ ã”ã¨ç®¡ç†ï¼‰
3. ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã®ãƒ¢ãƒ‡ãƒ«å¤‰æ›´é€šçŸ¥

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«: `gemma3:latest`
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆTemperature: `0.3`

---

## ğŸ“ æ³¨æ„äº‹é …

### security.js ã®ä¿®æ­£ã«ã¤ã„ã¦

**ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆ¥é€”ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚**

ä¿®æ­£ç®‡æ‰€ï¼ˆç´„46-49è¡Œç›®ï¼‰:
```javascript
// ã€å‰Šé™¤ã€‘ä»¥ä¸‹ã®2è¡Œã‚’å‰Šé™¤
// if (trimmed.length > 500) {
//     throw new Error('æŒ‡ç¤ºãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§500æ–‡å­—ï¼‰');
// }
```

### äº’æ›æ€§

- æ—¢å­˜ã®v6.6ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨­å®šã‚’å¼•ãç¶™ãå¯èƒ½
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ãªã—
- ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ ãªã—

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**
   ```bash
   cp public/index.html public/index.html.backup
   cp server.js server.js.backup
   cp security.js security.js.backup
   ```

2. **ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®**
   ```bash
   cp server.js /path/to/project/
   cp index.html /path/to/project/public/
   ```

3. **security.js ã®ä¿®æ­£**
   - `sanitizeAIInstruction()`é–¢æ•°ã‹ã‚‰æ–‡å­—æ•°åˆ¶é™ã‚’å‰Šé™¤

4. **ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•**
   ```bash
   npm start
   ```

5. **å‹•ä½œç¢ºèª**
   - ãƒ¢ãƒ‡ãƒ«é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒæ“ä½œå¯èƒ½ã‹
   - ãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - AIç·¨é›†ãŒé¸æŠã—ãŸãƒ¢ãƒ‡ãƒ«ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‹

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
2. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
3. OllamaãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
4. é¸æŠã—ãŸãƒ¢ãƒ‡ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª (`ollama list`)

---

*ä½œæˆæ—¥æ™‚: 2025-10-01*
*ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v6.7*
